{#
  Generic form group container which consists
  of form row: title/label and form field(s)

  Params:
    - field <@object> WTForm field
    - subfield <@object> (optional) WTForm field to include as subfield
    - title_as_label <@boolean|id> (optional, default: True)
    - show_title_row <@boolean> (optional, default: True)
      Whether to show the title row text as label
    - class_ <@string> (optional) CSS class attribute
#}
{% macro form_group(
    field,
    subfield=None,
    title_as_label=True,
    show_title_row=True,
    class_=''
  )
%}
  {% if field.flags.optional %}
    {% set label_text = field.label.text + ' (optional)' %}
  {% else %}
    {% set label_text = field.label.text %}
  {% endif %}
  {% set field_label = field.label(
      for=title_as_label if title_as_label is string else field.id,
      text=label_text
    )
  %}
  {% set errors = field.errors or subfield.errors %}
  <dl class="form-group {{ class_ }}{% if errors %} m-error{% endif %}">
    {% if show_title_row %}
      <dt class="form-row">
        {%- if title_as_label -%}
          {{- field_label -}}
        {%- else -%}
          {{ label_text }}
        {%- endif -%}
        {% if field.description or field.help_text %}
          <div class="field-help">
            {%- if field.description -%}
              <span class="field-description">
                {{- field.description -}}
              </span>
            {%- endif -%}
            {%- if field.more_info -%}
              <div class="field-more-info">
                {{- field.more_info|safe -}}
              </div>
            {%- endif -%}
          </div>
        {%- endif -%}
      </dt>
    {% endif %}
    <dd class="form-row">
      {{ caller() }}
    </dd>
    {% if errors %}
      <dd class="form-row">
        {{ field_errors(errors) }}
      </dd>
    {% endif %}
  </dl>
{% endmacro %}

{#
  Render field errors
  (including mutli-fields)

  Params:
    - errors <@object> WTForm field.errors
#}
{% macro field_errors(errors) %}
  <div class="field-error">
    {% set errors = errors.values() if errors is mapping else errors %}
    {% for error in errors %}
      {% if error is string %}
        <p>{{error}}</p>
      {% else %}
        {% for line in error %}
          <p>{{line}}</p>
        {% endfor %}
      {% endif %}
    {% endfor %}
  </div>
{% endmacro %}


{#
  Block level label used for single options per line

  Params:
    - field <@object> WTForm field
#}
{% macro block_label(field) %}
  <label class="block-label" for="{{field.id}}">
    {{ field }}
    {{ field.label.text }}

    {% if field.description %}
      <div class="field-help">
        {{field.description|safe}}
      </div>
    {% endif %}
  </label>
{% endmacro %}


{#
  Yes/No field

  Params:
    - field <@object> WTForm field
    - subfield <@object> (optional) WTForm field to include as subfield
                      (creates relationship via JS for conditional toggling)
#}
{% macro yesno_field(field, subfield=None) %}
  {# set subfields as macro caller and make them optional #}
  {% if caller %}
    {% set subfield_caller = caller() %}
  {% endif %}

  {% call form_group(field, subfield, title_as_label=False) %}
    {%- for option in field -%}
      <label class="radio-inline" for="{{option.id}}">
        {% if subfield %}
          {{- option(**{
              'data-conditional-controls': subfield.id,
              'data-conditional-show-value': '1'
            })
          }}
        {% else %}
          {{- option }}
        {% endif %}
        {{ option.label.text -}}
      </label>
    {%- endfor -%}
    {% if subfield and subfield_caller %}
      <div class="form-subfield s-hidden" data-conditional-id="{{subfield.id}}">
        {{ subfield_caller }}
      </div>
    {% endif %}
  {% endcall %}
{% endmacro %}


{#
  Text field

  Params:
    - field <@object> WTForm field
    - prefix <@string> (optional) Adds label with specified string before the field
    - suffix <@string> (optional) Adds label with specified string after the field
    - use_form_group <@boolean> (optional) Don't wrap in form group when set to False
    - class_ <@string> (optional) CSS class of input field
    - label_class <@string> (optional) CSS class of field label (when used as subfield)
#}
{% macro text_field(
  field,
  prefix=None,
  suffix=None,
  use_form_group=True,
  class_='',
  label_class=''
) %}
  {% if caller %}
    {% set text_field_caller = caller() %}
  {% endif %}

  {% if use_form_group %}
    {% call form_group(field) %}
      {% if prefix %}
        <label class="input-prefix" for="{{field.id}}">{{prefix}}</label>
      {% endif %}
      {{ field(class_='form-control ' + class_) }}
      {% if suffix %}
        <label class="input-suffix" for="{{field.id}}">{{suffix}}</label>
      {% endif %}

      {% if text_field_caller %}
        {{ text_field_caller }}
      {% endif %}
    {% endcall %}
  {% else %}
    {{ field.label(class_=label_class) }}
    {% if prefix %}
      <label class="input-prefix" for="{{field.id}}">{{prefix}}</label>
    {% endif %}
    {{ field(class_='form-control ' + class_) }}
    {% if suffix %}
      <label class="input-suffix" for="{{field.id}}">{{suffix}}</label>
    {% endif %}
  {% endif %}
{% endmacro %}


{#
  Textarea field

  Params:
    - field <@object> WTForm field
    - rows <@number> (optional, default: 4) HTML rows attribute
    - cols <@number> (optional, default: 40) HTML cols attribute
#}
{% macro textarea_field(field, rows=4, cols=40) %}
  {% call form_group(field) %}
    {{ field(class_='form-control', rows=rows, cols=cols) }}
  {% endcall %}
{% endmacro %}


{#
  List of checkboxes

  Params:
    - field <@object> WTForm field
#}
{% macro check_list_field(field) %}
  {% call form_group(field, False) %}
    {{ field(class_='form-option-list') }}
  {% endcall %}
{% endmacro %}


{#
  Money interval field

  Params:
    - field <@object> WTForm field
    - is_hidden <@boolean> (optional, default: False) Whether to render the field as hidden
    - use_form_group <@boolean> (optional, default: True) Whether to use form_group to wrap
        the field
#}
{% macro money_interval_field(field, is_hidden=False, use_form_group=True) %}
  {% if is_hidden %}
    <input type="hidden" name="{{ field.amount.name }}" value="0">
    <input type="hidden" name="{{ field.interval.name }}" value="per_week">
  {% else %}
    {% if use_form_group %}
      {% call form_group(field, title_as_label=field.amount.id) %}
        <label class="input-prefix" for="{{field.amount.id}}">£</label>
        {{ field.amount(class_='form-control') }}
        {{ field.interval(class_='form-control') }}
      {% endcall %}
    {% else %}
      {{field.label}}
      <label class="input-prefix" for="{{field.amount.id}}">£</label>
      {{ field.amount(class_='form-control') }}
      {{ field.interval(class_='form-control') }}
    {% endif %}
  {% endif %}
{% endmacro %}


{#
  Select field

  Params:
    - field <@object> WTForm field
#}
{% macro select_field(field) %}
  {% call form_group(field) %}
    {{ field(class_='form-control') }}
  {% endcall %}
{% endmacro %}


{#
  Adaptations field

  Params:
    - field <@object> WTForm field
#}
{% macro adaptations_field(field) %}
  <dl class="form-group">
    <dt class="form-row">
      {{ field.label }}
    </dt>
    <dd class="form-row">
      {{ field.bsl_webcam }}
      {{ field.bsl_webcam.label }}
    </dd>
    <dd class="form-row">
      {{ field.minicom }}
      {{ field.minicom.label }}
    </dd>
    <dd class="form-row">
      {{ field.text_relay }}
      {{ field.text_relay.label }}
    </dd>
    <dd class="form-row">
      {{ field.welsh }}
      {{ field.welsh.label }}
    </dd>
    <dd class="form-row">
      {{ field.is_other_language(**{
          'data-conditional-controls': field.other_language.id,
          'data-conditional-show-value': 'y'
        })
      }}
      {{ field.is_other_language.label }}
      <div class="form-subfield" data-conditional-id="{{field.other_language.id}}">
        {{ field.other_language.label(class='label-inline') }}
        {{ field.other_language(class_='form-control') }}
      </div>
    </dd>
  </dl>
{% endmacro %}


{#
  Form actions block

  Params:
    - button_label <@string> Button label
#}
{% macro actions(button_label) %}
  <p class="form-actions">
    <button type="submit" class="button button-larger">{{ button_label }}</button>
  </p>
{% endmacro %}


{#
  Show generic form errors alert

  Params:
    - form <@object> WTForm form object
#}
{% import "macros/element.html" as Element %}
{% macro handle_errors(form) %}
  {% if form.errors %}
    {% call Element.alert('error', icon='cross') %}
      <p>This form has errors.</p>
      <p>Please correct them and try again.</p>
    {% endcall %}
  {% endif %}
{% endmacro %}


{#
  Availability checker field

  Params:
    - field <@object> WTForm field
#}
{% macro availability_checker_field(field) %}
  {% call form_group(field) %}
    {% for radio in field.specific_day %}
      <p>
        {{ radio }} {{ radio.label }}
        {% if radio.id == 'specific_day-0' %}
          {{ field.time_today(class_='form-control') }}
        {% elif radio.id == 'specific_day-1' %}
          {{ field.time_tomorrow(class_='form-control') }}
        {% else %}
          {{ field.time_in_day(class_='form-control') }} {{ field.day(class_='form-control') }}
        {%  endif %}
      </p>
    {% endfor %}
  {% endcall %}
{% endmacro %}
