{% if request.path.startswith('/result') %}
  {% extends 'checker/base.html' %}
{% else %}
  {% extends 'base.html' %}
{% endif %}

{% import "macros/form.html" as Form %}
{% import "macros/subform.html" as Subform %}
{% import "macros/element.html" as Element %}

{% set title = _('Contact Civil Legal Advice') %}
{% block page_title %}{{ title }}{% endblock %}

{% block inner_content %}
  {% block page_text %}
    {% if config.CONTACT_ONLY %}
      {% call Element.alert() %}
        <p>{{ _('The full service is currently unavailable. However, you can still get in touch using the form below.') }}</p>
      {% endcall %}
    {% endif %}
    <h1>{{ title }}</h1>
    {#
      'n18' is the index of the node which corresponds to 'yes' in response
      to question 'Are you at immediate risk of harm?'
    #}
    {% if 'n18' in session.checker.diagnosis_previous_choices %}
      <h2 class="subtitle">
        {% trans %}If you're in immediate danger please call Civil Legal
        Advice on 0345 345 4 345. Call charges apply.{% endtrans %}
      </h2>
      <p>
        {% trans %}You can also ask us to call you back using the form below,
        which is free.{% endtrans %}
      </p>
      <p>
        {% trans %}If you're in an emergency situation, please call the police
        on 999.{% endtrans %}
      </p>
    {% else %}
      <p>
        {% trans %}Please submit your details to get in touch with Civil Legal Advice (CLA).{% endtrans %}
      </p>
      <p>
        {% trans %}You can choose to contact CLA yourself and speak to someone immediately (this is an 0345 number -
        <a href="https://www.gov.uk/call-charges" rel="external" target="_blank">call charges</a> apply)
        or ask us to call you back, which is free.{% endtrans %}
      </p>
      <p>{{ _('You’ll need to provide evidence of the financial information you’ve given us through this service.') }}</p>
    {% endif %}
  {% endblock %}

  <form method="POST" action="{{ url_for('contact.get_in_touch') }}" class="contact-form">
    {{ form.csrf_token }}
    {{ Form.handle_errors(form) }}

    {{ Form.text_input_fieldset(form.full_name, class_='m-large') }}

    {% call Form.fieldset(form.contact_type, class_='fieldset-group') %}
      <ul class="form-option-list">
        {%- for option in form.contact_type -%}
          <li>
            <label class="radio-inline" for="{{option.id}}">
              {{ option }}
              {{ option.label.text }}
            </label>

            {% if option.data == 'call' %}
              <div class="form-group form-subfield form-notice" data-controlled-by="contact_type" data-control-value="call">
                <p>
                  {{ _('We’ll give you the CLA phone number when you submit your details below.') }}
                </p>
              </div>
            {% elif option.data == 'callback' %}
              {{ Subform.callback(form) }}
            {% elif option.data == 'thirdparty' %}
              {{ Subform.thirdparty(form) }}
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endcall %}

    {{ Form.text_input_fieldset(form.email, class_='m-large') }}

    {{ Subform.address(form.address) }}

    {% call Form.fieldset(form.extra_notes, as_label=True) %}
      {% set max_length_validator = form.extra_notes.validators|selectattr('max')|first %}
      {% set max_length = max_length_validator.max if max_length_validator %}
      {{ form.extra_notes(class_='form-control m-full', rows=7, **{ 'data-character-count': max_length }) }}
    {% endcall %}

    {{ Subform.adaptations(form.adaptations) }}

    {% block what_happens_next_alert %}{% endblock %}

    {{ Form.honeypot(form) }}
    {{ Form.actions(_('Submit details')) }}
  </form>

  {% block notice %}
    <p class="notice">
      {% trans %}Protecting your personal data and your privacy is important to us.
      Read the full <a href="/privacy" target="_blank">Civil Legal Advice Privacy Statement</a>.{% endtrans %}
    </p>
  {% endblock %}
{% endblock %}


{% block javascripts %}
  {{ super() }}

  <script type="text/html" id="addressFinderButton">
    <button class="button-secondary address-finder-button" type="button">
      {{ _('Find UK address') }}
    </button>
  </script>

  <script type="text/html" id="addressFinderList">
    <div class="form-group form-subfield address-list">
      <select name="address" class="form-control">
        <option value="" disabled><%= count %> {{ _('addresses found') }}</option>
        <option value="">-- {{ _('Choose address') }} --</option>
        <% _.each(items, function(address, index) { %>
          <option value="<%= index %>"><%= address %></option>
        <% }); %>
      </select>
    </div>
  </script>

  <script type="text/html" id="characterCounter">
    <div class="character-counter <%= counter_class %>">
      <%= count %> {{ _('characters remaining') }}
    </div>
  </script>

  <script type="text/html" id="postcodeNotEnteredText">
    <div class="form-row field-error">
      <p>
        {{ _('Must contain a valid postcode') }}
      </p>
    </div>
  </script>

  <script type="text/html" id="noAddressesFoundText">
    <div class="form-row field-error">
      <p>
        {{ _('No addresses were found with that postcode, but you can still enter your address manually') }}
      </p>
    </div>
  </script>

  <script type="text/html" id="requestFailedText">
    <div class="form-row field-error">
      <p>
        {{ _('Request failed: ') }} <%= textStatus %>, <%= error %>
      </p>
    </div>
  </script>
{% endblock %}
